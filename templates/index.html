<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Tempomat</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <h1>Tempomat</h1>

    <h3>Uwagi</h3>
    <ol>
        <li>Aby rozpocząć działanie programu, należy wcisnąć przycisk Start. Wówczas pojazd zacznie jechać do przodu.</li>
        <li>Pojazd jest wyposażony w czujnik odległości, co pozwala mu określić, jak daleko znajduje się od przeszkody.</li>
        <li>Pojazd testowano na bieżni, a przed nim położono płaski kartonik imitujący ścianę.</li>
        <li>Dzięki zaimplementowanemu tempomatowi pojazd powinien poruszać się ze stałą prędkością niezależnie od warunków testowych.</li>
    </ol>

    <h3>Instrukcja obsługi</h3>
    <ol>
        <li>Ustaw parametry poniżej.</li>
        <li>Naciśnij Start – pojazd ruszy, a eksperyment się rozpocznie.</li>
        <li>Po określonym czasie pojazd zatrzyma się automatycznie.</li>
        <li>Naciśnij Wygeneruj wykres, aby zobaczyć dane z eksperymentu.</li>
    </ol>

    <form id="controlForm">
        <label class="slider-label">Nastawa regulatora kp: <span id="kpVal">{{ params.kp }}</span></label>
        <input type="range" name="kp" min="0.5" max="1.5" step="0.1" value="{{ params.kp }}" oninput="kpVal.innerText = this.value"><br>

        <label class="slider-label">Nastawa regulatora Ti: <span id="TiVal">{{ params.Ti }}</span></label>
        <input type="range" name="Ti" min="2.5" max="5" step="0.1" value="{{ params.Ti }}" oninput="TiVal.innerText = this.value"><br>

        <label class="slider-label">Nastawa regulatora kd: <span id="kdVal">{{ params.kd }}</span></label>
        <input type="range" name="kd" min="0.5" max="1.5" step="0.1" value="{{ params.kd }}" oninput="kdVal.innerText = this.value"><br>

        <label class="slider-label">Odległości jaką chcemy utrzymywać [m]: <span id="d_zadaneVal">{{ params.d_zadane }}</span></label>
        <input type="range" name="d_zadane" min="0.01" max="1.01" step="0.1" value="{{ params.d_zadane }}" oninput="d_zadaneVal.innerText = this.value"><br>

        <label class="slider-label">Okres próbkowania [s]: <span id="TpVal">{{ params.Tp }}</span></label>
        <input type="range" name="Tp" min="1" max="45" step="1" value="{{ params.Tp }}" oninput="TpVal.innerText = this.value"><br>

        <label class="slider-label">Czas symulacji [min]: <span id="t_symVal">{{ params.t_sym }}</span></label>
        <input type="range" name="t_sym" min="1" max="30" step="1" value="{{ params.t_sym }}" oninput="t_symVal.innerText = this.value"><br><br>

        <input id="start" type="button" value="Start">
        <input id="wyswietlanie" type="button" value="Wygeneruj wykres">
        <input id="reset" type="button" value="Reset">
        <input id="poweroff" type="button" value="Wyłącz">
    </form>

    <div style="clear:both;"></div>
    <div id="obrazek" style="display: none;">Proszę czekać, wyświetlam wykres</div>

    <footer>Wszelkie prawa zastrzeżone. &copy; Autorzy 2025 </footer>

    <script>
        let counter = 0;
        document.getElementById('wyswietlanie').disabled = true;

        function getParams() {
            const form = document.getElementById('controlForm');
            return {
                kp: parseFloat(form.kp.value),
                Ti: parseFloat(form.Ti.value),
                kd: parseFloat(form.kd.value),
                d_zadane: parseFloat(form.d_zadane.value),
                Tp: parseInt(form.Tp.value),
                t_sym: parseInt(form.t_sym.value)
            };
        }

        function ExecPythonCommand(cmd) {
            let request = new XMLHttpRequest();
            request.open("GET", "/" + cmd, true);
            request.send();
            console.log(cmd);
        }

        function start() {
            counter++;
            const p = getParams();
            document.getElementById('start').disabled = true;
            document.getElementById('reset').disabled = true;
            document.getElementById('poweroff').disabled = true;
            document.getElementById('wyswietlanie').disabled = true;

            ExecPythonCommand(`start(${counter},${p.kp},${p.Ti},${p.kd},${p.d_zadane},${p.Tp},${p.t_sym})`);

            setTimeout(() => {
                document.getElementById('start').disabled = false;
                document.getElementById('reset').disabled = false;
                document.getElementById('poweroff').disabled = false;
                document.getElementById('wyswietlanie').disabled = false;
            }, p.t_sym*60*1000);
        }

        function reset() {
            document.getElementById('obrazek').style.display = "none";
            ExecPythonCommand(`reset(${counter})`);
        }

        function poweroff() {
            ExecPythonCommand(`poweroff(${counter})`);
        }

        document.getElementById('start').addEventListener("click", start);
        document.getElementById('reset').addEventListener("click", reset);
        document.getElementById('poweroff').addEventListener("click", poweroff);
        document.getElementById('wyswietlanie').addEventListener("click", function () {
            document.getElementById('obrazek').innerHTML = `<img src="/static/plot${counter}.png"/>`;
            document.getElementById('obrazek').style.display = "block";
        });
    </script>
</body>
</html>
